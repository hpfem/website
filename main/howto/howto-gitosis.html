<html>
<body>

<h2>Hermes - Gitosis HowTo</h2>

<ul>

<li><b>Configuration of Gitosis</b><br>
<p>Every change to the configuration of gitosis should be pushed to <b>gitosis-admin.git</b>, and the changes will automatically be reflected. We should not change the gitosis-admin.git directly at the server (spilka). So, first clone the gitosis-admin.git:<br>
<b>$ git clone git@spilka:gitosis-admin.git</b>
<p>Now you have a directory named <b>gitosis-admin</b>, which has two major
parts: gitosis.conf and gitosis-export/keydir.</p>
<p>The <b>gitosis.conf</b> file is the control file you use to specify users, 
repositories and permissions. The <b>keydir</b> directory is where you store the public keys of all the users 
who have any sort of permissions to your repositories: one file per user. <br><br>

<b>How to add an user?</b><br>
First get the public key from the user and put it in the <b>keydir</b> directory as a file whose name ends with ".pub". <br>
For example the public key of <b>user</b> at <b>hostserver1</b> should be pasted in the file 
<b>user@hostserver1.pub</b>. Each file "*.pub" should contain one public key. If the user uses many machines then create different such files for different machines.<br></p>

<p>
Now in the <b>gitosis.conf</b>, you can add an user and keys for many machines like this: <br><br>
[group user] <br>
members = user@desktop user@hostserver2, user@hostserver1 <br>
where user@desktop and others refer to the files containing different keys 
at gitosis-export/keydir. <br></p> 

<p> You can add repositories and group members in the following way: <br><br>
[group h2dev] <br>
writable = hermes2d hermes1d himg <br>
members = @user1 @user2 @user3 <br> </p> 

<p> If web interface is needed, then add something like this in gitosis.conf:<br><br>
[repo hermes2d] <br>
daemon = yes <br>
gitweb = yes <br>
</p> 

After making these changes, you need to commit and push to gitosis-admin.git at the server.<br>
<b>$ git push origin master</b><br>

Once you push, the changes will be reflected in the git server.

<p>The new user can now try doing:<br>
$ git clone git@spilka.math.unr.edu:project.git <br>
or push to the official repos to which he has permission in gitosis.conf.
</p>
</li>
<li><b>Installation of Gitosis</b><br>
<p> First add a new user "git" and then sudo su git: <br>
$ adduser git <br>
$ sudo su git <br>
</p>

<p> Go to $HOME and make the directory: <br>
$ cd <br>
$ mkdir -p user/lib/python/ <br></p>

<p> Put the following at the beginning of .bashrc: <br>
export PYTHONPATH=$PYTHONPATH:$HOME/usr/lib/python/ <br>
export PATH="$HOME/usr/bin:$PATH" <br>
(If you don't put it at the beginning, the ssh will not run it 
due to the line "[ -z "$PS1" ] && return" in the bashrc.)
</p>

<p> Next, you clone and install Gitosis from Ondrej's repo (gitosis 
needed couple patches to make it work on spilka): <br>
$ mkdir repos; cd repos <br>
$ git clone git://github.com/certik/gitosis.git  <br>
$ cd gitosis <br>
$ git checkout --track origin/pu <br> 
$ python setup.py install --home=~/usr <br></p>
<p> To initialize Gitosis, first copy your public key to /tmp and then do: <br>
$ gitosis-init < /tmp/id_rsa.pub <br> 
$ cd repositories/gitosis-admin.git <br> 
$ chmod 755 hooks/post-update  <br> 
Also change "git-update-server-info" to "git update-server-info" in post-update<br>
$GIT_DIR=. hooks/post-update</p>

<p> Then, clone the gitosis-admin.git:<br>
$ git clone git@spilka:gitosis-admin.git <br>
Now, you have a directory named gitosis-admin, which has two major parts: 
gitosis.conf and gitosis-export/keydir, which you can change according to your need. After making changes you can push back so that the changes will be reflected. Please see the above section (Configuration of Gitosis) for details.<br></p> 
</ul>

</body>
</html>

