<html>
<body>

<h2>Hermes - Buildbot HowTo</h2>

<ul>

<li><b> How Buildbot works </b><br>

<p> The BuildBot is a system to automate the compile/test 
cycle required by most software projects to validate code 
changes. It not only can pinpont quickly the failure of 
compilation each time the code has been changed, but can run 
the builds on a variety of platforms as well. The overall goal 
is to reduce tree breakage and provide a platform to run 
tests or code-quality checks. 
</p>

<p> The following shows the control flow of Buildbot: </p>

<p> <b>1.</b> A developer commits some source code changes to git.
A trigger script will send this changes to buildmaster, the change
will include who made the change, what files were modified, which
revision, and checkin comments. </p> 

<p> <b>2.</b> Buildmaster distributes the changes to its schedulers.
Changes will go into a list "tree-stable-timer" of new Build. 
A Build is started on each configured Builders in parallel.</p>

<p> <b>3.</b> The build consists of a set of Steps. First, it 
checks for revision. Then it performs a compile and run
unit tests. As each step runs, the buildslave reports back command
output and return status ot the buildmaster.</p>

<p> <b>4.</b> Status message "Build Started", "Step Started" and 
"Build Finished", etc are published to a collection of Status 
Targets, for example, HTML display.</p>

<p> <b>5.</b> If a MailNotifier status target is active, then upon 
completion of a build, the developer whose changes were incorporated
 into this build will be notified.</p>


<li><b>Installation of Buildbot </b><br>
<p> <b>1. Requirements</b> <br>
Python 2.3 or later.<br>
Twisted-2.0.x or later. At least Twisted core package, TwistedMail, 
TwistedWeb and TwistedWords. <br>
ZopeInterface package required by Twisted.<br>
</p>

<p> <b>2.a Build on Linux(Ubuntu)</b> <br>
# sudo aptitude install python-twisted-core python-twisted-mail 
python-twisted-web python-twisted-words python-zope.interface <br>
# sudo aptitude install python-dev <br>
# wget http://downloads.sourceforge.net/buildbot/buildbot-0.7.12.tar.gz <br>
# tar -zxf buildbot-0.7.12.tar.gz <br>
# cd buildbot-0.7.12/  <br>
# python setup.py build <br>
# sudo python setup.py install <br> </p>

<p>After installation, run the trial test by: <br>
# PYTHONPATH=. trial buildbot.test<br>
</p>

<p> <b>2.b Build on MacOSX(10.6.3)</b> <br>

Install Xcode Developer Tools.<br>
Twisted 10.0.0 is installed under MacOSX 10.5.x later. <br>
# sudo aptitude install python-dev <br>
# wget http://downloads.sourceforge.net/buildbot/buildbot-0.7.12.tar.gz <br>
# tar -zxf buildbot-0.7.12.tar.gz <br>
# cd buildbot-0.7.12/  <br>
# python setup.py build <br>
# sudo python setup.py install <br> </p>


<p>After installation, run the trial test by: <br>
# PYTHONPATH=. trial buildbot.test<br>
</p>

<p> <b>2.c Build on Vista-cygwin</b> <br>
Since X/Cygwin doesn't have zopeinterface and Twisted, 
we need to install from source package: </p>

<p>
<a href="pkgs/zope.interface-3.6.1.tar.gz">zope.interface-3.6.1.tar.gz</a>,
<a href="pkgs/Twisted-10.0.0.tar.bz2">Twisted-10.0.0.tar.bz2</a>.
</p>

<p> Perform the following command from Administrator:<br>
# tar -zxf zope.interface-3.6.1.tar.gz <br>
# cd zope.interface-3.6.1/  <br>
# python setup.py build <br>
# python setup.py install <br> </p>

<p> Install gcc and gcc-mingw from X/Cygwin:<br>
# tar -jxf Twisted-10.0.0.tar.bz2 <br>
# cd Twisted-10.0.0/  <br>
# python setup.py build --compiler=mingw32 install<br> </p>

<p> If extensions won't build, try this instead:<br>
# python setup.py build_py build_scripts install --skip-build <br>
This will install bare minimum Twisted under X/Cygwin <br></p>

<p> Install Buildbot
# tar -zxf buildbot-0.7.12.tar.gz <br>
# cd buildbot-0.7.12/  <br>
# python setup.py build <br>
# sudo python setup.py install <br> </p>


<p>After installation, run the trial test by: <br>
# PYTHONPATH=. trial buildbot.test<br>
Since Twisted is not fully built, not all tests passed. 
</p>

<p> <b>3. Creating Buildmaster</b>  <br>
Issue the command from root:<br>
# adduser buildmaster <br>
# mkdir ~/Buildmasters/femhub <br>
# buildbot create-master -r /home/buildmaster/Buildmasters/femhub <br>
</p>

<p> <b>4. Creating Buildslave</b> <br>
Issue the command from root on each of the platforms:<br>
# adduser buildslave <br>
# mkdir ~/Buildslaves/femhub <br>
# buildbot create-slave /home/buildslave/Buildslaves/femhub 
MASTERHOST:PORT SLAVENAME PASSWD<br>
</p>

<p> <b>5. Usage of Buildbot </b> <br>

Launching the daemons on BuildMaster:<br>
# buildbot start    ~/Buildmasters/femhub <br>
# buildbot stop     ~/Buildmasters/femhub <br>
# buildbot reconfig ~/Buildmasters/femhub <br>
</p>

<p> Launching BuildSlave on each of the platform:<br>
# buildbot start /home/buildslave/Buildslaves/femhub <br> 
for Start buildbot on MacOSX, see <b>7. Using Launchd </b><br>
</p>


<p> <b>6. Git Hook </b> <br>
setup a hook file for git repository at 
/home/git/repos/femhub.git/hooks/post-receive: <br>
... <br>
echo "notifying buildbot..." <br>
buildbot sendchange --master buildbot.hpfem.org:9989 --u git-commit some_files <br>
...<br></p>

<b>7. Using Launchd </b> <br>
<p><b>Launchd</b> is Mac OSX substitude for /etc/rc/, init.d, and cron. If you launch 
buildbot in Mac OSX by the way described in section <b>5</b>, buildbot process will vanish
eventually.  </p>

<p>The proper way to launch buildbot in Mac OSX is to use launchd, whereas 
you will first need to create a plist file in /Library/LaunchDaemons/. For example, 
you could create a file /Library/LaunchDaemons/buildbot.slave.hermes3d.plist as 
following:</p>

<pre class="wiki">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
	&lt;key&gt;StandardOutPath&lt;/key&gt;
	&lt;string&gt;twistd.log&lt;/string&gt;

	&lt;key&gt;StandardErrorPath&lt;/key&gt;
	&lt;string&gt;twistd-err.log&lt;/string&gt;
	&lt;key&gt;EnvironmentVariables&lt;/key&gt;
	&lt;dict&gt;

		&lt;key&gt;PATH&lt;/key&gt;
		&lt;string&gt;/opt/local/bin:/sbin:/usr/sbin:/bin:/usr/bin&lt;/string&gt;
		&lt;key&gt;PYTHONPATH&lt;/key&gt;
		&lt;string&gt;/usr/lib/python2.6/&lt;/string&gt;

	&lt;/dict&gt;
	&lt;key&gt;GroupName&lt;/key&gt;
	&lt;string&gt;daemon&lt;/string&gt;
	&lt;key&gt;KeepAlive&lt;/key&gt;

	&lt;dict&gt;
		&lt;key&gt;SuccessfulExit&lt;/key&gt;
		&lt;false/&gt;
	&lt;/dict&gt;
	&lt;key&gt;<FONT COLOR="RED">Label</FONT>&lt;/key&gt;
	&lt;string&gt;<FONT COLOR="RED">buildbot.slave.hermes3d</FONT>&lt;/string&gt;
	&lt;key&gt;ProgramArguments&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;/opt/local/bin/twistd2.5&lt;/string&gt;

		&lt;string&gt;-no&lt;/string&gt;
		&lt;string&gt;-y&lt;/string&gt;
		&lt;string&gt;./buildbot.tac&lt;/string&gt;
	&lt;/array&gt;

	&lt;key&gt;RunAtLoad&lt;/key&gt;
	&lt;true/&gt;
	&lt;key&gt;<FONT COLOR="RED">UserName</FONT>&lt;/key&gt;
	&lt;string&gt;<FONT COLOR="RED">buildslave</FONT>&lt;/string&gt;

	&lt;key&gt;<FONT COLOR="RED">WorkingDirectory</FONT>&lt;/key&gt;
	&lt;string&gt;<FONT COLOR="RED">/Users/buildslave/Buildslaves/hermes3d</FONT>&lt;/string&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</pre>

<p>where, <b>Label</b> should match the plist name; <b>UserName</b> is the account in which you 
run your buildbot, <b>Working Directory</b> is the place in which your project is built. <br></p>

<p>This file must be owned by root:wheel; to launch the daemon, issuing the following comamnd from root: <br>
# launchctl load -w buildbot.slave.hermes2d.plist <br></p>




<b>8. Restarting Win PC </b> <br>

Login as Buildslave with the appropriate password.<br>

# cd ~/Buildsalves/femhub<br>
# buildbot start .<br>

# cd ~/Buildsalves/hermes1d<br>
# buildbot start .<br>

etc.

</li>
</ul>

</body>
</html>

